name: 'Claude Code Fix (Write Access)'

on:
  issue_comment:
    types: ['created']
  pull_request_review_comment:
    types: ['created']

jobs:
  claude-fix:
    # Only trigger on @claude-fix command from authorized users
    if: |
      (
        github.event_name == 'issue_comment' ||
        github.event_name == 'pull_request_review_comment'
      ) &&
      contains(github.event.comment.body, '@claude-fix') &&
      contains(fromJSON('["Oliver-Sheaky"]'), github.event.comment.user.login)

    runs-on: 'ubuntu-latest'

    permissions:
      contents: 'write' # Allow creating branches and editing files
      pull-requests: 'write' # Allow creating and updating pull requests
      issues: 'write' # Allow commenting on and updating issues
      id-token: 'write' # Required for OIDC authentication
      actions: 'read' # Read CI results

    steps:
      - name: 'Checkout repository'
        uses: 'actions/checkout@v4'
        with:
          fetch-depth: 0 # Full history for better context

      - name: 'Load fix instructions'
        id: 'load-instructions'
        env:
          EVENT_NAME: '${{ github.event_name }}'
          ISSUE_NUM: '${{ github.event.issue.number }}'
          PR_NUM: '${{ github.event.pull_request.number }}'
          REPO_NAME: '${{ github.repository }}'
          TRIGGERED_BY: '${{ github.event.comment.user.login }}'
        run: |
          # Get the issue or PR number from the event
          if [ "$EVENT_NAME" == "issue_comment" ]; then
            ISSUE_NUMBER="${ISSUE_NUM}"
          else
            ISSUE_NUMBER="${PR_NUM}"
          fi

          # Read the template and replace the AI_ASSISTANT placeholder
          INSTRUCTIONS=$(cat .github/prompts/docker_fix_prompt.md | \
            sed 's/{AI_ASSISTANT}/claude/g')

          # Use heredoc to preserve multiline content with context prepended
          echo "CUSTOM_INSTRUCTIONS<<EOF" >> $GITHUB_OUTPUT
          echo "# GitHub Context" >> $GITHUB_OUTPUT
          echo "- Repository: ${REPO_NAME}" >> $GITHUB_OUTPUT
          echo "- Issue/PR Number: ${ISSUE_NUMBER}" >> $GITHUB_OUTPUT
          echo "- Triggered by: ${TRIGGERED_BY}" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "$INSTRUCTIONS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: 'Run Claude Code Fix'
        id: 'claude'
        uses: 'anthropics/claude-code-action@beta'
        timeout-minutes: 30
        env:
          GH_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
        with:
          claude_code_oauth_token: '${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}'

          # Custom trigger phrase for fix workflow
          trigger_phrase: '@claude-fix'

          # Fix-specific instructions loaded from template
          custom_instructions: >-
            ${{ steps.load-instructions.outputs.CUSTOM_INSTRUCTIONS }}

          # Docker/Infrastructure specific allowed tools
          # Removed Python-specific tools (pytest, mypy, ruff, pip)
          # Added Docker Compose validation tools
          allowed_tools: >-
            Edit(*),MultiEdit(*),Write(*),Read(*),Grep(*),LS(*),Glob(*),
            Bash(git *),Bash(docker *),Bash(docker-compose *),
            Bash(MSYS_NO_PATHCONV=1 docker *),
            Bash(MSYS_NO_PATHCONV=1 docker-compose *),Bash(cd *),Bash(pwd),
            Bash(ls *),Bash(cat *),Bash(head *),Bash(tail *),Bash(wc *),
            Bash(find *),Bash(grep *),Bash(rg *),Bash(sed *),Bash(awk *),
            Bash(curl *),Bash(wget *),Bash(echo *),Bash(mkdir *),
            WebSearch(*),WebFetch(*)

  unauthorized-message:
    # Post message for unauthorized users
    if: |
      (
        github.event_name == 'issue_comment' ||
        github.event_name == 'pull_request_review_comment'
      ) &&
      contains(github.event.comment.body, '@claude-fix') &&
      !contains(fromJSON('["Oliver-Sheaky"]'), github.event.comment.user.login)

    runs-on: 'ubuntu-latest'

    permissions:
      issues: 'write'
      pull-requests: 'write'

    steps:
      - name: 'Post unauthorized message'
        uses: 'actions/github-script@v7'
        with:
          script: |
            const comment = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚ùå @${context.actor} - You are not authorized to
                trigger Claude fixes.\n\nOnly maintainers can trigger
                Claude: Please ask a maintainer to run the fix command.`
            };

            if (context.eventName === 'issue_comment') {
              await github.rest.issues.createComment({
                ...comment,
                issue_number: context.issue.number
              });
            } else if (context.eventName === 'pull_request_review_comment') {
              await github.rest.pulls.createReplyForReviewComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                comment_id: context.payload.comment.id,
                body: comment.body
              });
            }
